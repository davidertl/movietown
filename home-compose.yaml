networks:
  external:
    name: external
    driver: bridge
    ipam:
      driver: default
      config:
        - subnet: "${DOCKER_SUBNET:?Add to your env file}"
          gateway: "${DOCKER_GATEWAY:?Add to your env file}"
  internal:
    name: internal
    driver: bridge
    ipam:
      driver: default
      config:
        - subnet: "${INTERNAL_SUBNET:?Add to your env file}"
          gateway: "${INTERNAL_GATEWAY:?Add to your env file}"

services:
###########################################################################
# AUTHENTIK WORKER (Cloud Authentik)
###########################################################################
  authentik-worker:
    image: ghcr.io/goauthentik/server:${AUTHENTIK_VERSION:?err}
    container_name: authentik-worker
    restart: unless-stopped
    user: ${PUID:?err}:${PGID:?err}
    networks:
      - external
      - internal
    command: worker
    environment:
      - TZ=${TIMEZONE:?err}
      - AUTHENTIK_SECRET_KEY=${AUTHENTIK_SECRET_KEY:?err}
      - AUTHENTIK_REDIS__HOST=${AUTHENTIK_REDIS__HOST:?err}
      - AUTHENTIK_POSTGRESQL__HOST=${AUTHENTIK_POSTGRESQL__HOST:?err}
      - AUTHENTIK_POSTGRESQL__NAME=${AUTHENTIK_DATABASE:?err}
      - AUTHENTIK_POSTGRESQL__USER=${POSTGRESQL_USERNAME:?err}
      - AUTHENTIK_POSTGRESQL__PASSWORD=${POSTGRESQL_PASSWORD:?err}
      - AUTHENTIK_ERROR_REPORTING__ENABLED=${AUTHENTIK_ERROR_REPORTING__ENABLED:-false}
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ${FOLDER_FOR_DATA:?err}/certs:/certs
      - ${FOLDER_FOR_DATA:?err}/authentik/media:/media
      - ${FOLDER_FOR_DATA:?err}/authentik/templates:/templates
    healthcheck:
      test: ["CMD-SHELL", "ps -ef | grep worker | grep -v grep"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s


###########################################################################
# WATCHTOWER (Container Auto-Update)
###########################################################################
  watchtower:
    image: containrrr/watchtower:latest
    container_name: watchtower
    depends_on:
      gluetun:
        condition: service_healthy
        restart: true
    networks:
      - external
    user: ${PUID:?err}:${PGID:?err}
    environment:
      - TZ=${TIMEZONE:?err}
      - WATCHTOWER_CLEANUP=true
      - WATCHTOWER_LABEL_ENABLE=false
      - WATCHTOWER_POLL_INTERVAL=3600
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock

   
############################################################################
# TSD Proxy # https://almeidapaulopt.github.io
############################################################################

  tsdproxy:
    image: almeidapaulopt/tsdproxy:1
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - datadir:/data
      - ${FOLDER_FOR_DATA:?err}/tsdproxy_arr:/config
    restart: unless-stopped
    networks:
      - internal
      - external
    environment:
      - TS_AUTHKEY=${TAILSCALE_AUTH_KEY:?TAILSCALE_AUTH_KEY missing}
    ports:
      - "80:8080"


###########################################################################
# GLUETUN (VPN CLIENT)
###########################################################################
  gluetun:
    image: qmcgaw/gluetun:latest
    container_name: gluetun
    restart: always
    cap_add:
      - NET_ADMIN
    devices:
      - /dev/net/tun:/dev/net/tun
    ports:
      - "${WEBUI_PORT_QBITTORRENT:-8200}:8200"
      - "${QBIT_PORT:-6881}:6881"
      - "${WEBUI_PORT_BAZARR:-6767}:6767"
      - "${WEBUI_PORT_JELLYSEERR:-5055}:5055"
      - "${WEBUI_PORT_LIDARR:-8686}:8686"
      - "${WEBUI_PORT_MYLAR:-8090}:8090"
      - "${WEBUI_PORT_PROWLARR:-9696}:9696"
      - "${WEBUI_PORT_RADARR:-7878}:7878"
      - "${WEBUI_PORT_READARR:-8787}:8787"
      - "${WEBUI_PORT_SABNZBD:-8080}:8080"
      - "${WEBUI_PORT_SONARR:-8989}:8989"
      - "${WEBUI_PORT_FILEBOT:-5454}:5454"
      - "${WEBUI_PORT_TDARR:-8265}:8265"
      - "${FLARESOLVERR_PORT:-8191}:8191"
      - "${TDARR_SERVER_PORT:-8266}:8266"
      - "8888:8888/tcp"
      - "8388:8388/tcp"
      - "8388:8388/udp"
      - "${GLUETUN_CONTROL_PORT:?err}:${GLUETUN_CONTROL_PORT:?err}"
    volumes:
      - "${FOLDER_FOR_DATA:?err}/gluetun:/gluetun"
    environment:
      PUID: "${PUID:?err}"
      PGID: "${PGID:?err}"
      UMASK: "${UMASK:?err}"
      TZ: "${TIMEZONE:?err}"
      VPN_SERVICE_PROVIDER: "${VPN_SERVICE_PROVIDER:?err}"
      OPENVPN_USER: "${VPN_USERNAME:?err}"
      OPENVPN_PASSWORD: "${VPN_PASSWORD:?err}"
      SERVER_CATEGORIES: "${SERVER_CATEGORIES}"
      SERVER_CITIES: "${SERVER_CITIES}"
      SERVER_COUNTRIES: "${SERVER_COUNTRIES}"
      SERVER_HOSTNAMES: "${SERVER_HOSTNAMES}"
      SERVER_REGIONS: "${SERVER_REGIONS}"
      FIREWALL_OUTBOUND_SUBNETS: "${LOCAL_SUBNET:?err}"
      OPENVPN_CUSTOM_CONFIG: "${OPENVPN_CUSTOM_CONFIG}"
      HTTP_CONTROL_SERVER_ADDRESS: ":${GLUETUN_CONTROL_PORT:?err}"
      VPN_TYPE: "${VPN_TYPE}"
      VPN_ENDPOINT_IP: "${VPN_ENDPOINT_IP}"
      VPN_ENDPOINT_PORT: "${VPN_ENDPOINT_PORT}"
      WIREGUARD_PUBLIC_KEY: "${WIREGUARD_PUBLIC_KEY}"
      WIREGUARD_PRIVATE_KEY: "${WIREGUARD_PRIVATE_KEY}"
      WIREGUARD_PRESHARED_KEY: "${WIREGUARD_PRESHARED_KEY}"
      WIREGUARD_ADDRESSES: "${WIREGUARD_ADDRESSES}"
      HTTPPROXY: "on"
      SHADOWSOCKS: "on"
    networks:
      - external
      - internal
    labels:
      - "tsdproxy.enable=true"
      - "tsdproxy.name=gluetun_arr"
      - "tsdproxy.dash.label=ARR"
      - "tsdproxy.dash.label=movietown"
    healthcheck:
      test: ["CMD", "pgrep", "gluetun"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s

###########################################################################
# MEDIA & ARR SERVICES (alle mit Healthcheck, Ã¼ber Gluetun getunnelt)
###########################################################################

  bazarr:
    image: lscr.io/linuxserver/bazarr:latest
    container_name: bazarr
    restart: unless-stopped
    depends_on:
      gluetun:
        condition: service_healthy
    volumes:
      - ${FOLDER_FOR_DATA:?err}/bazarr:/config
      - ${FOLDER_FOR_MEDIA:?err}:/data
    environment:
      - PUID=${PUID:?err}
      - PGID=${PGID:?err}
      - TZ=${TIMEZONE:?err}
      - DOCKER_MODS=ghcr.io/themepark-dev/theme.park:bazarr
      - TP_THEME=${TP_THEME:?err}
    network_mode: "service:gluetun"
    labels:
      - "tsdproxy.enable=true"
      - "tsdproxy.name=bazarr"
      - "tsdproxy.dash.label=ARR"
      - "tsdproxy.dash.label=movietown"
    healthcheck:
      test: ["CMD", "pgrep", "bazarr"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s

  jellyseerr:
    image: fallenbagel/jellyseerr:latest
    container_name: jellyseerr
    restart: unless-stopped
    depends_on:
      gluetun:
        condition: service_healthy
    volumes:
      - ${FOLDER_FOR_DATA:?err}/jellyseerr:/app/config
    environment:
      - PUID=${PUID:?err}
      - PGID=${PGID:?err}
      - UMASK=${UMASK:?err}
      - TZ=${TIMEZONE:?err}
    network_mode: "service:gluetun"
    labels:
      - "tsdproxy.enable=true"
      - "tsdproxy.name=jellyseerr"
      - "tsdproxy.dash.label=ARR"
      - "tsdproxy.dash.label=movietown"
    healthcheck:
      test: ["CMD", "node", "-e", "process.exit(require('fs').existsSync('/app/config/config.json') ? 0 : 1)"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s

  filebot:
    image: rednoah/filebot:xpra
    container_name: filebot
    restart: unless-stopped
    depends_on:
      gluetun:
        condition: service_healthy
    volumes:
      - ${FOLDER_FOR_DATA:?err}/filebot:/data/filebot
      - ${FOLDER_FOR_MEDIA:?err}/filebot:/filebot
    environment:
      - PUID=${PUID:?err}
      - PGID=${PGID:?err}
      - UMASK=${UMASK:?err}
      - TZ=${TIMEZONE:?err}
      - DARK_MODE=1
    network_mode: "service:gluetun"
    labels:
      - "tsdproxy.enable=true"
      - "tsdproxy.name=filebot"
      - "tsdproxy.dash.label=ARR"
      - "tsdproxy.dash.label=movietown"
    healthcheck:
      test: ["CMD", "pgrep", "java"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s

  lidarr:
    image: lscr.io/linuxserver/lidarr:latest
    container_name: lidarr
    restart: unless-stopped
    depends_on:
      gluetun:
        condition: service_healthy
    volumes:
      - ${FOLDER_FOR_DATA:?err}/lidarr:/config
      - ${FOLDER_FOR_MEDIA:?err}:/data
    environment:
      - PUID=${PUID:?err}
      - PGID=${PGID:?err}
      - TZ=${TIMEZONE:?err}
      - DOCKER_MODS=ghcr.io/themepark-dev/theme.park:lidarr
      - TP_THEME=${TP_THEME:?err}
    network_mode: "service:gluetun"
    labels:
      - "tsdproxy.enable=true"
      - "tsdproxy.name=lidarr"
      - "tsdproxy.dash.label=ARR"
      - "tsdproxy.dash.label=movietown"
    healthcheck:
      test: ["CMD", "pgrep", "lidarr"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s

  mylar:
    image: lscr.io/linuxserver/mylar3:latest
    container_name: mylar
    restart: unless-stopped
    depends_on:
      gluetun:
        condition: service_healthy
    volumes:
      - ${FOLDER_FOR_DATA:?err}/mylar:/config
      - ${FOLDER_FOR_MEDIA:?err}:/data
    environment:
      - PUID=${PUID:?err}
      - PGID=${PGID:?err}
      - TZ=${TIMEZONE:?err}
      - DOCKER_MODS=ghcr.io/themepark-dev/theme.park:mylar3
      - TP_THEME=${TP_THEME:?err}
    network_mode: "service:gluetun"
    labels:
      - "tsdproxy.enable=true"
      - "tsdproxy.name=mylarr"
      - "tsdproxy.dash.label=ARR"
      - "tsdproxy.dash.label=movietown"
    healthcheck:
      test: ["CMD", "pgrep", "mylar3"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s

  prowlarr:
    image: lscr.io/linuxserver/prowlarr:develop
    container_name: prowlarr
    restart: unless-stopped
    depends_on:
      gluetun:
        condition: service_healthy
    volumes:
      - ${FOLDER_FOR_DATA:?err}/prowlarr:/config
    environment:
      - PUID=${PUID:?err}
      - PGID=${PGID:?err}
      - TZ=${TIMEZONE:?err}
      - DOCKER_MODS=ghcr.io/themepark-dev/theme.park:prowlarr
      - TP_THEME=${TP_THEME:?err}
    network_mode: "service:gluetun"
    labels:
      - "tsdproxy.enable=true"
      - "tsdproxy.name=prowlarr"
      - "tsdproxy.dash.label=ARR"
      - "tsdproxy.dash.label=movietown"
    healthcheck:
      test: ["CMD", "pgrep", "prowlarr"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s

  radarr:
    image: lscr.io/linuxserver/radarr:latest
    container_name: radarr
    restart: unless-stopped
    depends_on:
      gluetun:
        condition: service_healthy
    volumes:
      - ${FOLDER_FOR_DATA:?err}/radarr:/config
      - ${FOLDER_FOR_MEDIA:?err}:/data
    environment:
      - PUID=${PUID:?err}
      - PGID=${PGID:?err}
      - TZ=${TIMEZONE:?err}
      - DOCKER_MODS=ghcr.io/themepark-dev/theme.park:radarr
      - TP_THEME=${TP_THEME:?err}
    network_mode: "service:gluetun"
    labels:
      - "tsdproxy.enable=true"
      - "tsdproxy.name=radarr"
      - "tsdproxy.dash.label=ARR"
      - "tsdproxy.dash.label=movietown"
    healthcheck:
      test: ["CMD", "pgrep", "radarr"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s

  readarr:
    image: lscr.io/linuxserver/readarr:amd64-0.4.3-develop
    container_name: readarr
    restart: unless-stopped
    depends_on:
      gluetun:
        condition: service_healthy
    volumes:
      - ${FOLDER_FOR_DATA:?err}/readarr:/config
      - ${FOLDER_FOR_MEDIA:?err}:/data
    environment:
      - PUID=${PUID:?err}
      - PGID=${PGID:?err}
      - TZ=${TIMEZONE:?err}
      - DOCKER_MODS=ghcr.io/themepark-dev/theme.park:readarr
      - TP_THEME=${TP_THEME:?err}
    network_mode: "service:gluetun"
    labels:
      - "tsdproxy.enable=true"
      - "tsdproxy.name=readarr"
      - "tsdproxy.dash.label=ARR"
      - "tsdproxy.dash.label=movietown"
    healthcheck:
      test: ["CMD", "pgrep", "readarr"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s

  sabnzbd:
    image: lscr.io/linuxserver/sabnzbd:latest
    container_name: sabnzbd
    restart: unless-stopped
    depends_on:
      gluetun:
        condition: service_healthy
    volumes:
      - ${FOLDER_FOR_DATA:?err}/sabnzbd:/config
      - ${FOLDER_FOR_MEDIA:?err}/downloads:/downloads
    environment:
      - PUID=${PUID:?err}
      - PGID=${PGID:?err}
      - TZ=${TIMEZONE:?err}
    network_mode: "service:gluetun"
    labels:
      - "tsdproxy.enable=true"
      - "tsdproxy.name=sabnzbd"
      - "tsdproxy.dash.label=torrent"
      - "tsdproxy.dash.label=movietown"
    healthcheck:
      test: ["CMD", "pgrep", "sabnzbd"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s

  sonarr:
    image: lscr.io/linuxserver/sonarr:latest
    container_name: sonarr
    restart: unless-stopped
    depends_on:
      gluetun:
        condition: service_healthy
    volumes:
      - ${FOLDER_FOR_DATA:?err}/sonarr:/config
      - ${FOLDER_FOR_MEDIA:?err}:/data
    environment:
      - PUID=${PUID:?err}
      - PGID=${PGID:?err}
      - TZ=${TIMEZONE:?err}
      - DOCKER_MODS=ghcr.io/themepark-dev/theme.park:sonarr
      - TP_THEME=${TP_THEME:?err}
    network_mode: "service:gluetun"
    labels:
      - "tsdproxy.enable=true"
      - "tsdproxy.name=sonarr"
      - "tsdproxy.dash.label=ARR"
      - "tsdproxy.dash.label=movietown"
    healthcheck:
      test: ["CMD", "pgrep", "sonarr"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s

  qBittorrent:
    image: lscr.io/linuxserver/qbittorrent:latest
    container_name: qbittorrent
    restart: unless-stopped
    depends_on:
      gluetun:
        condition: service_healthy
    volumes:
      - ${FOLDER_FOR_DATA:?err}/qbittorrent:/config
      - ${FOLDER_FOR_MEDIA:?err}/downloads:/downloads
    environment:
      - PUID=${PUID:?err}
      - PGID=${PGID:?err}
      - TZ=${TIMEZONE:?err}
      - UMASK=${UMASK:?err}
      - WEBUI_PORT=${WEBUI_PORT_QBITTORRENT:-8200}
    network_mode: "service:gluetun"
    labels:
      - "tsdproxy.enable=true"
      - "tsdproxy.name=qBittorrent"
      - "tsdproxy.dash.label=torrent"
      - "tsdproxy.dash.label=movietown"
    healthcheck:
      test: ["CMD", "pgrep", "qbittorrent-nox"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s


volumes:
  #Authentik
  redis:
    # TSD Proxy Data
  datadir: